{% extends "base.html" %}
{% block additional_preloads %}
<link rel="preload" as="image" href="/resources/home.gif">
<link rel="preload" as="image" href="/resources/map-ice.png">
<link rel="preload" as="image" href="/resources/map-candy2.png">
<link rel="preload" as="image" href="/resources/map-candy.png">
<link rel="preload" as="image" href="/resources/map-badlands.png">
<link rel="preload" as="image" href="/resources/main-characters.png">
<link rel="preload" as="image" href="/resources/main-map.png">
<link rel="preload" as="image" href="/resources/discord-white.png">
<link rel="preload" as="image" href="/resources/Cartoon_Network_2010.svg">
{% endblock %}
{% block content %}
    <script>
        // Inyectado por Flask: creatures (array) e is_admin (bool)
        window.__CREATURES__ = {{ creatures|default([]) | tojson | safe }};
        // Aqu√≠ se define window.__IS_ADMIN__ usando Jinja2 y Flask:
        window.__IS_ADMIN__ = {{ is_admin | default(false) | tojson | safe }};
    </script>


        <section class="relative py-20 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-brand-500/20 to-purple-600/20 blur-3xl"></div>
            <div class="max-w-7xl mx-auto px-4 relative z-10">
                <div class="text-center space-y-4">
                    <h1 class="text-5xl sm:text-6xl lg:text-7xl font-extrabold drop-shadow-2xl" style="font-family:'Rubik Doodle Shadow',system-ui" data-text-key="cards.hero.title">
    üÉè Card Database
</h1>
<p class="text-lg sm:text-xl text-white/80 max-w-2xl mx-auto" data-text-key="cards.hero.desc">
    Discover all creatures, spells, and buildings from Card Wars Kingdom. Master their abilities and dominate the battlefield!
</p>
                </div>
            </div>
        </section>

        <section class="max-w-7xl mx-auto px-4 py-8">
            <div class="bg-white/5 backdrop-blur-lg rounded-2xl p-6 border border-white/10 shadow-2xl">
                <div class="mt-4 text-center text-sm text-white/60">
                    <span id="cardCount">Showing all cards</span>
                </div>

                <div id="creatureFolders" class="mt-4 flex flex-wrap gap-2"></div>

                <pre id="debugOutput" class="mt-3 p-3 bg-white/5 text-xs rounded-md overflow-auto max-h-40"></pre>
            </div>
        </section>

        <section class="max-w-7xl mx-auto px-4 py-12">
            <div id="cardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {# Server-side fallback: render cards from injected "creatures" so page shows even if JS fails #}
                {% for c in creatures %}
                <article class="card-item border-2 rounded-xl p-4 bg-white/5 rarity-common flex flex-col items-center text-center" data-folder="{{ c.folder }}" style="min-height:220px;position:relative;">
                    <div style="width:100%;height:160px;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:12px;background:linear-gradient(180deg,#00000022,#00000011);">
                        {% set img = (c.images[0] if c.images|length > 0 else '') %}
                        {% if img %}
                            {% if c.folder %}
                                <img src="/resources/Creature Book/{{ c.folder }}/{{ img }}" alt="{{ c.name }}" style="max-width:100%;max-height:100%;object-fit:contain;">
                            {% else %}
                                <img src="/resources/Creature Book/{{ img }}" alt="{{ c.name }}" style="max-width:100%;max-height:100%;object-fit:contain;">
                            {% endif %}
                        {% else %}
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='white'%3ENo+Image%3C/text%3E%3C/svg%3E" alt="No image" style="max-width:100%;max-height:100%;object-fit:contain;">
                        {% endif %}
                    </div>
                    <h3 class="text-lg font-bold mt-3">{{ ('#' ~ c.number ~ ' ') if c.number is not none and c.number != none else '' }}{{ c.name }}</h3>
                    <div class="text-xs text-white/60 mt-2">{{ (c.images|length ~ ' image(s)') if (c.images is defined) else 'No images' }}</div>
                </article>
                {% endfor %}
             </div>
           </section>
    </main>

    <footer class="bg-[#0a0a0d] py-10 border-t border-white/10 backdrop-blur-lg mt-20">
        <div class="max-w-7xl mx-auto px-4 flex flex-col items-center text-center space-y-6">
            <img src="/resources/card-wars-kingdom-icon.png" alt="Card Wars Icon" class="w-16 h-16 drop-shadow-xl">
            <div class="flex flex-col sm:flex-row gap-4 text-sm font-semibold">
                <a href="/download" class="text-white/90 hover:text-white hover:underline">FREE DOWNLOAD</a>
                <a href="https://discord.gg/card-wars-revived-1227932764117143642" target="_blank" class="text-white/90 hover:text-white hover:underline">DISCORD SERVER</a>
                <a href="/status" class="text-white/90 hover:text-white hover:underline">STATUS PAGE</a>
            </div>
            <p class="text-xs text-white/60 max-w-lg leading-relaxed">
                ¬© 2025 Card Wars Kingdom Remake ‚Ä¢ Fan Project<br>
                Cartoon Network‚Ñ¢ & Warner Bros. Discovery own all original rights. No monetization involved.
            </p>
        </div>
    </footer>

    <button id="editModeBtn" title="Edit creatures" style="position:fixed;right:20px;bottom:20px;z-index:90;display:none;background:linear-gradient(135deg,#a532ff,#625fff);color:#fff;border:none;padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(101,37,255,0.25);cursor:pointer;" onclick="window.openEditorModal(event)">
    ‚úé Edit Creatures
</button>

<button id="adminToggleBtn" title="Login/Logout" style="display:block;position:fixed;right:20px;bottom:80px;z-index:90;background:#222;color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;">
    Admin Login
</button>

<div id="editorModal" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;padding:24px;overflow:auto;">
    <div class="editor-modal-content" style="background:#0b0b0e;color:#fff;max-width:1000px;width:100%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h2 style="margin:0;font-size:18px;">Edit Creature Book</h2>
            <button id="editorClose" style="background:transparent;border:1px solid #333;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;">Close</button>
        </div>

        <div id="editorHelp" style="font-size:12px;color:#cfcfcf;margin-bottom:10px;">
            Rename folders or upload images. Backend endpoints expected:
            POST /creature-book-rename { folder, newName } and
            POST /creature-book-upload (form: folder, file)
        </div>

        <div id="editorList" style="display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;padding-right:8px;">
            <div class="text-white/60">Cargando lista...</div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button id="editorRefresh" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Refresh</button>
            <button id="editorCloseBottom" style="background:#333;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<div id="loginModal" style="display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div class="login-modal-content" style="background:#0b0b0e;color:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
        <h3 style="margin:0 0 8px 0">Admin Login</h3>
        <input id="loginPassword" type="password" placeholder="Password" style="width:100%;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid #333;background:#17171a;color:white;">
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="loginCancel" style="background:#333;color:#fff;padding:8px 10px;border-radius:6px;border:none">Cancel</button>
            <button id="loginSubmit" style="background:#625fff;color:#fff;padding:8px 10px;border-radius:6px;border:none">Login</button>
        </div>
        <div id="loginStatus" style="margin-top:8px;color:#f88;font-size:13px;"></div>
    </div>
</div>

    <script>
// Helper debug reporter (muestra texto en el pre#debugOutput y en consola)
function reportDebug(msg) {
    try {
        const dbg = document.getElementById('debugOutput');
        if (dbg) {
            const prefix = new Date().toISOString().substring(11, 19) + ' ‚Ä∫ ';
            // Limita el historial de debug para que no crezca demasiado
            const maxLines = 10;
            const currentContent = dbg.textContent || '';
            const lines = currentContent.split('\n').filter(line => line.trim() !== '');
            const newContent = prefix + String(msg) + '\n' + lines.slice(0, maxLines - 1).join('\n');
            dbg.textContent = newContent;
        }
    } catch (e) { /* ignore */ }
    try { console.log('[cards debug]', msg); } catch(e) {}
}

// Placeholder data URL for missing images
function placeholderDataUrl() {
    return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100%25' height='100%25' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10' fill='white'%3ENo+Image%3C/text%3E%3C/svg%3E";
}

// Capture global uncaught errors so we can see why rendering stops
window.addEventListener('error', (ev) => {
    reportDebug(`Uncaught error: ${ev.message} at ${ev.filename}:${ev.lineno}:${ev.colno}`);
});
window.addEventListener('unhandledrejection', (ev) => {
    reportDebug('Unhandled promise rejection: ' + (ev.reason && ev.reason.message ? ev.reason.message : JSON.stringify(ev.reason)));
});

// ----------------------------------------------------------------------
// --- FUNCIONES DE ADMINISTRACI√ìN: LOGIN / LOGOUT / UI SETUP ---
// ----------------------------------------------------------------------

function updateAdminUI(isAdmin) {
    // Establece el estado de admin globalmente para que otros scripts lo detecten
    window.__IS_ADMIN__ = isAdmin;
    document.documentElement.setAttribute('data-is-admin', isAdmin ? '1' : '0');

    // Actualiza los textos y visibilidad de los botones de admin/edici√≥n
    const adminBtn = document.getElementById('adminToggleBtn');
    const editBtns = [
        document.getElementById('editModeBtn'), 
        document.getElementById('headerEditBtn'),
        document.getElementById('pageEditBtn'),
        document.getElementById('mobileEditLink')
    ].filter(Boolean);

    if (adminBtn) adminBtn.textContent = isAdmin ? 'Admin Logout' : 'Admin Login';
    editBtns.forEach(btn => btn.style.display = isAdmin ? 'block' : 'none');

    // Esto tambi√©n disparar√° enableAdminCardEdit() v√≠a MutationObserver
}

async function handleLogin() {
    const passwordInput = document.getElementById('loginPassword');
    const statusDiv = document.getElementById('loginStatus');
    const password = passwordInput ? passwordInput.value : '';

    if (!password) {
        if (statusDiv) statusDiv.textContent = 'Password is required.';
        return;
    }

    if (statusDiv) statusDiv.textContent = 'Logging in...';

    try {
        const resp = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            updateAdminUI(true);
            if (statusDiv) statusDiv.textContent = 'Login successful!';
            document.getElementById('loginModal').style.display = 'none';
            reportDebug('Admin login successful.');
            // Recarga la lista para que aparezcan los botones de edici√≥n
            await loadAndRenderWiki(); 
        } else {
            if (statusDiv) statusDiv.textContent = data.error || 'Login failed.';
            updateAdminUI(false);
        }
    } catch (error) {
        if (statusDiv) statusDiv.textContent = 'Network error during login.';
        console.error('Login error:', error);
    }
}

async function handleLogout() {
    if (!confirm('Are you sure you want to log out?')) return;
    try {
        const resp = await fetch('/logout', { method: 'POST' });
        // No importa si falla, limpiamos la UI de todas formas
        updateAdminUI(false);
        alert('Logged out.');
        reportDebug('Admin logged out.');
        await loadAndRenderWiki();
    } catch (error) {
        updateAdminUI(false);
        alert('Logged out (network error).');
    }
}

function openLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginStatus').textContent = '';
    }
}

function closeLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) modal.style.display = 'none';
}

function setupAdminUI() {
    // 1. Initial UI update based on server-injected state
    updateAdminUI(!!window.__IS_ADMIN__);

    // 2. Wire the main admin toggle button
    const adminBtn = document.getElementById('adminToggleBtn');
    if (adminBtn) {
        adminBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (window.__IS_ADMIN__) {
                handleLogout();
            } else {
                openLoginModal();
            }
        });
    }

    // 3. Wire login modal buttons
    document.getElementById('loginSubmit')?.addEventListener('click', handleLogin);
    document.getElementById('loginCancel')?.addEventListener('click', closeLoginModal);
    document.getElementById('loginPassword')?.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    // 4. Wire header Admin Link (for mobile)
    document.getElementById('mobileAdminLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (window.__IS_ADMIN__) {
            handleLogout();
        } else {
            openLoginModal();
        }
        // Cierra el panel m√≥vil despu√©s de la acci√≥n
        document.getElementById('mobilePanel').style.maxHeight = '0';
    });

    // 5. Wire editor modal close buttons
    document.getElementById('editorClose')?.addEventListener('click', () => {
        document.getElementById('editorModal').style.display = 'none';
    });
    document.getElementById('editorCloseBottom')?.addEventListener('click', () => {
        document.getElementById('editorModal').style.display = 'none';
    });
}


// ----------------------------------------------------------------------
// --- FUNCIONES DE ADMINISTRACI√ìN: RENAME / UPLOAD (INTERACCI√ìN CON FLASK) ---
// ----------------------------------------------------------------------

async function renameFolder(folder, newName, listItemElement) {
    if (!folder || !newName || !window.__IS_ADMIN__) {
        alert("Admin required, folder and new name are necessary.");
        return;
    }

    const newNameClean = newName.trim();
    if (newNameClean.length === 0) {
        alert("New name cannot be empty.");
        return;
    }

    if (!confirm(`Renombrar la carpeta '${folder}' a un nombre basado en '${newNameClean}'? Esto afectar√° a todas las rutas de im√°genes.`)) {
        return;
    }
    
    // Muestra estado de "Loading" en el item
    if (listItemElement) listItemElement.style.opacity = '0.5';

    try {
        const resp = await fetch('/creature-book-rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder: folder, newName: newNameClean })
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            alert(`¬°Renombrado exitoso! Nueva carpeta: ${data.folder}`);
            // Recarga la lista en el modal y la lista principal
            await loadEditableList();
            await loadAndRenderWiki();
        } else {
            alert(`Error al renombrar: ${data.error}`);
        }
    } catch (error) {
        alert('Error de red al renombrar: ' + error.message);
        console.error('Rename error:', error);
    } finally {
        if (listItemElement) listItemElement.style.opacity = '1';
    }
}

async function uploadImage(folder, fileInput, listItemElement) {
    const file = fileInput.files[0];
    // Verifica que file exista antes de acceder a file.name
    if (!folder || !file || !window.__IS_ADMIN__) {
        alert("Admin required, folder and file are necessary.");
        return;
    }
    if (!file.name) {
        alert("No file selected or file is invalid.");
        return;
    }
    if (!confirm(`Subir la imagen '${file.name}' a la carpeta '${folder}'?`)) {
        return;
    }

    // Muestra estado de "Loading" en el item
    if (listItemElement) listItemElement.style.opacity = '0.5';

    try {
        const formData = new FormData();
        formData.append('folder', folder);
        formData.append('file', file);

        const resp = await fetch('/creature-book-upload', {
            method: 'POST',
            body: formData,
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
            alert(`¬°Subida exitosa! Archivo: ${data.filename}`);
            fileInput.value = ''; // Limpiar el campo de archivo
            // Recarga la lista en el modal y la lista principal
            await loadEditableList();
            await loadAndRenderWiki();
        } else {
            alert(`Error al subir imagen: ${data.error}`);
        }
    } catch (error) {
        alert('Error de red al subir la imagen: ' + error.message);
        console.error('Upload error:', error);
    } finally {
        if (listItemElement) listItemElement.style.opacity = '1';
    }
}

// ----------------------------------------------------------------------
// --- FUNCIONES DE RENDERING DE LISTA EDITABLE ---
// ----------------------------------------------------------------------

function renderEditableList(creatures) {
    const container = document.getElementById('editorList');
    if (!container) return;

    container.innerHTML = ''; // Limpiar contenido anterior
    
    // Normalizar y ordenar la lista
    const normalized = creatures.map(it => {
        if (typeof it === 'string') return { folder: it, name: it, images: [] };
        return { folder: it.folder || it.name || '', name: it.name || it.folder || '', images: it.images || it.files || [] };
    }).sort((a,b) => {
        const na = parseNumberFromFolder(a.folder || a.name);
        const nb = parseNumberFromFolder(b.folder || b.name);
        if (na !== nb) return na - nb;
        return (a.name || '').localeCompare(b.name || '');
    });

    if (normalized.length === 0) {
        container.innerHTML = '<div class="text-white/60">No se encontraron criaturas para editar.</div>';
        return;
    }

    // Crea un item editable por cada criatura/carpeta
    normalized.forEach(c => {
        const item = document.createElement('div');
        item.className = 'editor-item';

        const folderSpan = document.createElement('span');
        folderSpan.textContent = c.folder;
        folderSpan.title = 'Current Folder Name';
        folderSpan.style.width = '120px'; // Fijo para consistencia
        folderSpan.style.overflow = 'hidden';
        folderSpan.style.textOverflow = 'ellipsis';
        folderSpan.style.whiteSpace = 'nowrap';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'New Name (e.g. 001 New Card Name)';
        nameInput.value = c.name; // Usar el nombre actual como sugerencia de cambio

        const renameBtn = document.createElement('button');
        renameBtn.className = 'rename-btn';
        renameBtn.textContent = 'Rename';
        renameBtn.onclick = () => renameFolder(c.folder, nameInput.value, item);

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.title = 'Select an image to upload';

        const uploadBtn = document.createElement('button');
        uploadBtn.className = 'upload-btn';
        uploadBtn.textContent = 'Upload';
        uploadBtn.onclick = () => uploadImage(c.folder, fileInput, item);

        item.appendChild(folderSpan);
        item.appendChild(nameInput);
        item.appendChild(renameBtn);
        item.appendChild(fileInput);
        item.appendChild(uploadBtn);

        container.appendChild(item);
    });

    // Desplazar al item que fue clicado si existe
    if (window.__targetEditorFolder) {
        const targetItem = Array.from(container.children).find(el => {
            const span = el.querySelector('span');
            return span && span.textContent === window.__targetEditorFolder;
        });
        if (targetItem) {
            targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetItem.style.boxShadow = '0 0 10px 2px #625fff';
            setTimeout(() => targetItem.style.boxShadow = 'none', 3000); // Resalta por un momento
        }
        delete window.__targetEditorFolder;
    }
}

// ----------------------------------------------------------------------
// --- FUNCIONES DE RENDERING DE WIKI (Se mantienen, pero se simplifican) ---
// ----------------------------------------------------------------------

async function fetchCreatureBookList() {
    // 1) Prefer server-injected data
    if (Array.isArray(window.__CREATURES__) && window.__CREATURES__.length) {
        return window.__CREATURES__;
    }
    // 2) Try the expected endpoint
    try {
        const resp = await fetch('/creature-book-list', { method: 'GET' });
        if (resp.ok) {
            const data = await resp.json();
            if (Array.isArray(data)) return data;
        }
    } catch (err) {
        console.warn('/creature-book-list failed, trying fallback:', err);
    }
    // Retorna vac√≠o si falla, la l√≥gica de fallback se elimin√≥ para simplificar
    return []; 
}

function parseNumberFromFolder(name) {
    const m = String(name).match(/^\s*0*([0-9]+)/);
    return m ? parseInt(m[1], 10) : Infinity;
}

function makeImageUrl(folder, filename) {
    if (!filename) return '';
    return folder
        ? `/resources/Creature Book/${folder}/${filename}`
        : `/resources/Creature Book/${filename}`;
}

function createWikiCard(item) {
    // item: { folder, name, images: [...] }
    const folder = item.folder || '';
    const name = item.name || folder;
    const imgs = item.images || item.files || [];
    const number = parseNumberFromFolder(folder || name);
    const first = imgs && imgs.length ? imgs[0] : null;
    const imgSrc = first ? makeImageUrl(folder, first) : placeholderDataUrl();

    const card = document.createElement('article');
    card.className = 'card-item border-2 rounded-xl p-4 bg-white/5 rarity-common flex flex-col items-center text-center';
    card.style.minHeight = '220px';
    card.style.position = 'relative'; // Necesario para el bot√≥n de edici√≥n
    card.dataset.folder = folder;

    const imgWrap = document.createElement('div');
    imgWrap.style.width = '100%';
    imgWrap.style.height = '160px';
    imgWrap.style.display = 'flex';
    imgWrap.style.alignItems = 'center';
    imgWrap.style.justifyContent = 'center';
    imgWrap.style.overflow = 'hidden';
    imgWrap.style.borderRadius = '12px';
    imgWrap.style.background = 'linear-gradient(180deg,#00000022,#00000011)';

    const img = document.createElement('img');
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    img.style.objectFit = 'contain';
    img.alt = name;
    img.loading = 'lazy';
    img.src = imgSrc;
    if (first) img.onerror = () => { img.src = placeholderDataUrl(); };
    imgWrap.appendChild(img);

    const title = document.createElement('h3');
    title.className = 'text-lg font-bold mt-3';
    title.textContent = (Number.isFinite(number) ? `#${number} ` : '') + name;

    const meta = document.createElement('div');
    meta.className = 'text-xs text-white/60 mt-2';
    meta.textContent = (imgs && imgs.length) ? `${imgs.length} image(s)` : 'No images';

    card.appendChild(imgWrap);
    card.appendChild(title);
    card.appendChild(meta);

    return card;
}

// Add edit buttons to cards when admin is active
function enableAdminCardEdit() {
    try {
        const isAdmin = document.documentElement.getAttribute('data-is-admin') === '1';
         document.querySelectorAll('#cardsGrid .card-item').forEach(card => {
             const existing = card.querySelector('.card-edit-btn');
             if (existing) existing.remove();
             if (!isAdmin) return;
             
             const btn = document.createElement('button');
             btn.type = 'button';
             btn.className = 'card-edit-btn';
             btn.textContent = 'Edit';
             btn.style.position = 'absolute';
             btn.style.top = '8px';
             btn.style.right = '8px';
             btn.style.padding = '6px 8px';
             btn.style.borderRadius = '8px';
             btn.style.background = 'rgba(98,95,255,0.95)';
             btn.style.color = '#fff';
             btn.style.border = 'none';
             btn.style.cursor = 'pointer';
             btn.style.zIndex = 40;
             const folder = card.dataset.folder || '';
             btn.title = folder || 'Edit item';
             btn.addEventListener('click', async (e) => {
                 e.stopPropagation();
                 window.__targetEditorFolder = folder;
                 window.openEditorModal(e);
             });
             card.appendChild(btn);
         });
     } catch (err) {
         console.warn('enableAdminCardEdit error', err);
     }
}

function renderWiki(items) {
    const grid = document.getElementById('cardsGrid');
    grid.innerHTML = '';
    if (!items || items.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-white/60">No creatures found.</div>';
        document.getElementById('cardCount').textContent = `Showing 0 creatures`;
        return;
    }

    const normalized = items.map(it => {
        if (typeof it === 'string') return { folder: it, name: it, images: [] };
        return { folder: it.folder || it.name || '', name: it.name || it.folder || '', images: it.images || it.files || [] };
    }).sort((a,b) => {
        const na = parseNumberFromFolder(a.folder || a.name);
        const nb = parseNumberFromFolder(b.folder || b.name);
        if (na !== nb) return na - nb;
        return (a.name || '').localeCompare(b.name || '');
    });

    normalized.forEach(item => {
        const card = createWikiCard(item);
        grid.appendChild(card);
    });

    document.getElementById('cardCount').textContent = `Showing ${normalized.length} creatures`;
    enableAdminCardEdit();
}

/* verify endpoint and load */
async function verifyCreatureEndpoint() {
    if (Array.isArray(window.__CREATURES__) && window.__CREATURES__.length) {
        return true;
    }
    try {
        const res = await fetch('/creature-book-list', { method: 'GET' });
        return res.ok;
    } catch (err) {
        reportDebug(`Error contacting /creature-book-list. Check backend: ${err.message}`);
        return false;
    }
}

async function loadAndRenderWiki() {
     try {
         const ok = await verifyCreatureEndpoint();
         if (!ok) {
             document.getElementById('cardsGrid').innerHTML = '<div class="col-span-full text-center text-white/60">Endpoint /creature-book-list no disponible. Revisa backend.</div>';
             return;
         }
         reportDebug('Fetching creature list ...');
         const list = await fetchCreatureBookList();
         renderWiki(Array.isArray(list) ? list : (list && Array.isArray(list.creatures) ? list.creatures : []));
     } catch (err) {
         document.getElementById('cardsGrid').innerHTML = '<div class="col-span-full text-center text-white/60">Error loading creatures.</div>';
         reportDebug('Error loading creatures: ' + (err && err.message ? err.message : String(err)));
     }
}
 
// Define loadEditableList function (Ahora carga y renderiza la lista en el modal)
async function loadEditableList() {
    try {
        const resp = await fetch('/creature-book-list');
        if (!resp.ok) throw new Error('Failed to load creature list from backend.');
        const creatures = await resp.json();
        renderEditableList(creatures);
    } catch (err) {
        console.error('loadEditableList error:', err);
        alert('Error loading creature list: ' + err.message);
        document.getElementById('editorList').innerHTML = `<div style="color:red;">Error: ${err.message}</div>`;
    }
}


// Explicaci√≥n de openEditorModal (La misma que la anterior, pero ahora llama a la funci√≥n loadEditableList)
async function openEditorModal(e) {
    e && e.preventDefault && e.preventDefault();
    const isAdmin = !!window.__IS_ADMIN__ || document.documentElement.getAttribute('data-is-admin') === '1';
    
    if (!isAdmin) {
        alert('Debes iniciar sesi√≥n como administrador para editar. Haz clic en "Admin Login" para continuar.');
        openLoginModal();
        return;
    }

    const editorModal = document.getElementById('editorModal');
    if (editorModal) editorModal.style.display = 'flex';
    
    const help = document.getElementById('editorHelp');
    if (help) help.textContent = 'Cambiando el nombre en el campo de texto y haciendo clic en "Rename" se actualizar√° la carpeta. Selecciona un archivo y haz clic en "Upload" para a√±adir una imagen.';
    
    await loadEditableList();
}


document.addEventListener('DOMContentLoaded', () => {
    try {
        // Carga y muestra wiki cards
        loadAndRenderWiki().catch(e => reportDebug('initial loadAndRenderWiki failed: ' + (e && e.message ? e.message : e)));
        
        // Configura la UI de administraci√≥n (login/logout/botones)
        setupAdminUI();

        // Observa data-is-admin para actualizar los botones de edici√≥n de las tarjetas
        try {
            const mo = new MutationObserver((mutations) => {
                for (const m of mutations) {
                    if (m.type === 'attributes' && m.attributeName === 'data-is-admin') {
                        try { enableAdminCardEdit(); } catch(e){/*ignore*/ }
                    }
                }
            });
            mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-is-admin'] });
        } catch(e) { console.warn('MutationObserver unavailable', e); }

        // Asigna la funci√≥n globalmente y conecta el bot√≥n de refrescar
        window.openEditorModal = openEditorModal;
        document.getElementById('editorRefresh')?.addEventListener('click', loadEditableList);

        // Mobile menu toggle logic
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobilePanel = document.getElementById('mobilePanel');
        if (mobileMenuBtn && mobilePanel) {
            mobileMenuBtn.addEventListener('click', () => {
                const isOpen = mobilePanel.style.maxHeight !== '0px';
                mobilePanel.style.maxHeight = isOpen ? '0' : '900px';
                mobilePanel.style.padding = isOpen ? '0' : '12px 0';
                mobileMenuBtn.setAttribute('aria-expanded', !isOpen);
            });
        }
        
    } catch (e) {
        reportDebug('DOM Content Loaded error: ' + (e && e.message ? e.message : e));
    }
});
</script>
{% endblock %}