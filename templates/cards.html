<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preload" as="image" href="/Welcome Card Wars Kingdom_files/Main-Logo.webp">
    <link rel="preload" as="image" href="/Welcome Card Wars Kingdom_files/card-wars-kingdom-icon.png">
    <link rel="stylesheet" href="/Welcome Card Wars Kingdom_files/a53f14ee4cfcc268.css" data-precedence="next">
    <link rel="icon" href="https://i.postimg.cc/522JrMVz/AT-Card-Wars2-Logo-Eng-1.png">
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="anonymous">
    <title>Welcome Card Wars Kingdom</title>
    <meta name="description" content="Card Wars Kingdom ‚Äì Free to Play Online Card Game based on Cartoon Network's Adventure Time.">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Doodle+Shadow&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Welcome Card Wars Kingdom_files/a53f14ee4cfcc268.css">
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(165, 50, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(165, 50, 255, 0.8); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        .animate-fadeInUp {
            animation: fadeInUp 0.8s ease-out forwards;
        }
        .hero-gif-container {
            animation: pulse-glow 2s ease-in-out infinite;
            background: linear-gradient(135deg, rgba(165, 50, 255, 0.1) 0%, rgba(98, 95, 255, 0.1) 100%);
            backdrop-filter: blur(10px);
        }
        /* Mobile menu: collapsed by default (existing markup uses max-h-0) */
        [class*="sm:hidden"][class*="bg-[#0a0a0af0]"] { transition: max-height .28s ease, padding .28s ease; overflow: hidden; }
        .mobile-menu-open { max-height: 900px !important; padding: 12px 0 !important; }
        /* Ensure images scale on small screens */
        @media (max-width:640px) {
            img { max-width: 100%; height: auto; }
            .hero-gif-container { padding: 16px; }
            .shiny-wrap { padding-left: 14px; padding-right:14px; }
            /* reduce huge headings a mobile friendly size */
            h1 { font-size: clamp(20px, 6vw, 56px); }
        }

        /* Ensure header logo scales properly on mobile (fix Android Chrome) */
        .site-logo {
            height: 36px;
            max-height: 40px;
            width: auto;
            object-fit: contain;
            display: block;
        }
        @media (min-width: 640px) {
            .site-logo { height: 54px; max-height: 64px; }
        }
        @media (min-width: 1024px) {
            .site-logo { height: 64px; max-height: 80px; }
        }
    </style>
</head>
<body class="font-[Poppins] antialiased bg-black text-white">
	<!-- Server-injected state -->
	<script>
		// Inyectado por Flask: creatures (array) e is_admin (bool)
		window.__CREATURES__ = {{ creatures|default([]) | tojson | safe }};
		window.__IS_ADMIN__ = {{ is_admin | default(false) | tojson | safe }};
	</script>

    <nav class="w-full fixed top-0 z-50 backdrop-blur-xl bg-[#00000080] border-b border-white/10 shadow-[0_2px_30px_-8px_rgba(165,50,255,0.4)] site-header">
        <div class="mx-auto max-w-7xl px-4 h-16 flex items-center justify-between">
            <a class="flex items-center gap-2" href="/">
                <img src="/Welcome Card Wars Kingdom_files/Main-Logo.webp" alt="CWK" class="site-logo drop-shadow-lg">
            </a>

            <!-- Desktop links -->
            <div class="hidden sm:flex items-center gap-6 font-medium tracking-wide">
                <a class="text-white/80 hover:text-white transition" href="/">Home</a>
                <a class="text-white hover:text-white transition border-b-2 border-brand-500" href="/cards">Cards</a>
                <a class="text-white/80 hover:text-white transition" href="/status">Status</a>
                <a class="text-white/80 hover:text-white transition" href="https://discord.gg/card-wars-revived-1227932764117143642">Support</a>
            </div>

            <!-- Desktop download button -->
            <a href="/download" class="hidden sm:flex shiny-wrap relative inline-flex items-center justify-center rounded-md bg-brand-500 px-5 py-3 text-white shadow hover:opacity-95 transition">
                <span class="relative z-[1] flex items-center gap-2">
                    <span class="material-symbols-outlined">download</span>Download
                </span>
            </a>

            <!-- Desktop edit button (visible to admin) -->
            <button id="headerEditBtn"
    class="sm:inline-flex items-center gap-2 px-3 py-2 rounded-md border border-white/10 text-white"
    style="background:transparent;margin-left:8px;display:block;"
    title="C: rename cards and add images"
    onclick="window.openEditorModal(event)">
    ‚úé Edit Creatures
</button>

            <!-- Desktop admin button -->
            <button id="headerAdminBtn" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-md border border-white/10 text-white" style="background:transparent;margin-left:8px;">
                Admin Login
            </button>

            <!-- Mobile menu button (visible on small screens) -->
            <button id="mobileMenuBtn" aria-label="Open menu" aria-expanded="false" class="sm:hidden inline-flex h-9 w-9 items-center justify-center rounded-md text-white hover:bg-white/10 transition">
                <span class="material-symbols-outlined text-xl">menu</span>
            </button>
        </div>

        <!-- Mobile panel (collapsible) -->
        <div id="mobilePanel" class="mobile-panel sm:hidden bg-[#0a0a0af0] backdrop-blur-xl">
            <div class="px-4 py-2">
                <a href="/" aria-label="Home">Home</a>
                <a href="/cards" aria-label="Cards">Cards</a>
                <a href="/status" aria-label="Status">Status</a>
                <a href="/download" aria-label="Download">Download</a>
                <a href="#" id="mobileEditLink" class="block text-white/90 hover:text-white py-2" style="display:block;" onclick="window.openEditorModal(event)">Edit Creatures</a>
                <a href="#" id="mobileAdminLink" aria-label="Admin">Admin Login</a>
                <a href="https://discord.gg/card-wars-revived-1227932764117143642" target="_blank" rel="noopener">Support</a>
            </div>
        </div>
    </nav>

    <!-- Add this button near the top of <main> for page editing -->
<main class="pt-16 min-h-screen bg-gradient-to-b from-black via-[#0a0a0d] to-black">
    <div style="position:fixed;left:20px;top:80px;z-index:90;">
        <button id="pageEditBtn" style="display:block;background:linear-gradient(135deg,#a532ff,#625fff);color:#fff;border:none;padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(101,37,255,0.25);cursor:pointer;" onclick="window.openEditorModal(event)">
            ‚úé Edit Page (Rename & Add Images)
        </button>
    </div>

        <!-- Hero Section -->
        <section class="relative py-20 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-brand-500/20 to-purple-600/20 blur-3xl"></div>
            <div class="max-w-7xl mx-auto px-4 relative z-10">
                <div class="text-center space-y-4">
                    <!-- make page title & description editable -->
<h1 class="text-5xl sm:text-6xl lg:text-7xl font-extrabold drop-shadow-2xl" style="font-family:'Rubik Doodle Shadow',system-ui" data-text-key="cards.hero.title">
    üÉè Card Database
</h1>
<p class="text-lg sm:text-xl text-white/80 max-w-2xl mx-auto" data-text-key="cards.hero.desc">
    Discover all creatures, spells, and buildings from Card Wars Kingdom. Master their abilities and dominate the battlefield!
</p>
                </div>
            </div>
        </section>

        <!-- Filters & Search -->
        <section class="max-w-7xl mx-auto px-4 py-8">
            <div class="bg-white/5 backdrop-blur-lg rounded-2xl p-6 border border-white/10 shadow-2xl">
                <div class="mt-4 text-center text-sm text-white/60">
                    <span id="cardCount">Showing all cards</span>
                </div>

                <!-- Lista de carpetas (creatures) -->
                <div id="creatureFolders" class="mt-4 flex flex-wrap gap-2"></div>

                <!-- Debug output: muestra JSON recibido / errores -->
                <pre id="debugOutput" class="mt-3 p-3 bg-white/5 text-xs rounded-md overflow-auto max-h-40"></pre>
            </div>
        </section>

        <!-- Cards Grid -->
        <section class="max-w-7xl mx-auto px-4 py-12">
            <div id="cardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {# Server-side fallback: render cards from injected "creatures" so page shows even if JS fails #}
                {% for c in creatures %}
                <article class="card-item border-2 rounded-xl p-4 bg-white/5 rarity-common flex flex-col items-center text-center" data-folder="{{ c.folder }}" style="min-height:220px;position:relative;">
                    <div style="width:100%;height:160px;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:12px;background:linear-gradient(180deg,#00000022,#00000011);">
                        {% set img = (c.images[0] if c.images|length > 0 else '') %}
                        {% if img %}
                            {% if c.folder %}
                                <img src="/Welcome Card Wars Kingdom_files/Creature Book/{{ c.folder }}/{{ img }}" alt="{{ c.name }}" style="max-width:100%;max-height:100%;object-fit:contain;">
                            {% else %}
                                <img src="/Welcome Card Wars Kingdom_files/Creature Book/{{ img }}" alt="{{ c.name }}" style="max-width:100%;max-height:100%;object-fit:contain;">
                            {% endif %}
                        {% else %}
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='white'%3ENo+Image%3C/text%3E%3C/svg%3E" alt="No image" style="max-width:100%;max-height:100%;object-fit:contain;">
                        {% endif %}
                    </div>
                    <h3 class="text-lg font-bold mt-3">{{ ('#' ~ c.number ~ ' ') if c.number is not none and c.number != none else '' }}{{ c.name }}</h3>
                    <div class="text-xs text-white/60 mt-2">{{ (c.images|length ~ ' image(s)') if (c.images is defined) else 'No images' }}</div>
                </article>
                {% endfor %}
             </div>
         </section>
    </main>

    <footer class="bg-[#0a0a0d] py-10 border-t border-white/10 backdrop-blur-lg mt-20">
        <div class="max-w-7xl mx-auto px-4 flex flex-col items-center text-center space-y-6">
            <img src="/Welcome Card Wars Kingdom_files/card-wars-kingdom-icon.png" alt="Card Wars Icon" class="w-16 h-16 drop-shadow-xl">
            <div class="flex flex-col sm:flex-row gap-4 text-sm font-semibold">
                <a href="/download" class="text-white/90 hover:text-white hover:underline">FREE DOWNLOAD</a>
                <a href="https://discord.gg/card-wars-revived-1227932764117143642" target="_blank" class="text-white/90 hover:text-white hover:underline">DISCORD SERVER</a>
                <a href="/status" class="text-white/90 hover:text-white hover:underline">STATUS PAGE</a>
            </div>
            <p class="text-xs text-white/60 max-w-lg leading-relaxed">
                ¬© 2025 Card Wars Kingdom Remake ‚Ä¢ Fan Project<br>
                Cartoon Network‚Ñ¢ & Warner Bros. Discovery own all original rights. No monetization involved.
            </p>
        </div>
    </footer>

    <!-- floating edit button -->
<button id="editModeBtn" title="Edit creatures" style="position:fixed;right:20px;bottom:20px;z-index:90;display:block;background:linear-gradient(135deg,#a532ff,#625fff);color:#fff;border:none;padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(101,37,255,0.25);cursor:pointer;" onclick="window.openEditorModal(event)">
    ‚úé Edit Creatures
</button>

<button id="adminToggleBtn" title="Login/Logout" style="display:block;position:fixed;right:20px;bottom:80px;z-index:90;background:#222;color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;">
	<!-- text replaced by JS -->
</button>

<!-- Editor modal (hidden by default) -->
<div id="editorModal" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;padding:24px;overflow:auto;">
    <div class="editor-modal-content" style="background:#0b0b0e;color:#fff;max-width:1000px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h2 style="margin:0;font-size:18px;">Edit Creature Book</h2>
            <button id="editorClose" style="background:transparent;border:1px solid #333;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;">Close</button>
        </div>

        <div id="editorHelp" style="font-size:12px;color:#cfcfcf;margin-bottom:10px;">
            Rename folders or upload images. Backend endpoints expected:
            POST /creature-book-rename { folder, newName } and
            POST /creature-book-upload (form: folder, file)
        </div>

        <div id="editorList" style="display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;padding-right:8px;"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button id="editorRefresh" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Refresh</button>
            <button id="editorCloseBottom" style="background:#333;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<!-- Add Login Modal (place near editor modal or end of body) -->
<div id="loginModal" style="display:none;position:fixed;inset:0;z-index:120;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
	<div class="login-modal-content" style="background:#0b0b0e;color:#fff;">
		<h3 style="margin:0 0 8px 0">Admin Login</h3>
		<input id="loginPassword" type="password" placeholder="Password" style="width:100%;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid #333;background:#071;color:white;">
		<div style="display:flex;gap:8px;justify-content:flex-end;">
			<button id="loginCancel" style="background:#333;color:#fff;padding:8px 10px;border-radius:6px;border:none">Cancel</button>
			<button id="loginSubmit" style="background:#625fff;color:#fff;padding:8px 10px;border-radius:6px;border:none">Login</button>
		</div>
		<div id="loginStatus" style="margin-top:8px;color:#f88;font-size:13px;"></div>
	</div>
</div>

    <script>
// Helper debug reporter (muestra texto en el pre#debugOutput y en consola)
function reportDebug(msg) {
    try {
        const dbg = document.getElementById('debugOutput');
        if (dbg) {
            const prefix = new Date().toISOString() + ' ‚Ä∫ ';
            dbg.textContent = prefix + String(msg) + '\n\n' + (dbg.textContent || '');
        }
    } catch (e) { /* ignore */ }
    try { console.log('[cards debug]', msg); } catch(e) {}
}

// Capture global uncaught errors so we can see why rendering stops
window.addEventListener('error', (ev) => {
    reportDebug(`Uncaught error: ${ev.message} at ${ev.filename}:${ev.lineno}:${ev.colno}`);
});
window.addEventListener('unhandledrejection', (ev) => {
    reportDebug('Unhandled promise rejection: ' + (ev.reason && ev.reason.message ? ev.reason.message : JSON.stringify(ev.reason)));
});

async function fetchCreatureBookList() {
    // 1) Prefer server-injected data
    if (Array.isArray(window.__CREATURES__) && window.__CREATURES__.length) {
        return window.__CREATURES__;
    }

    // 2) Try the expected endpoint
    try {
        const resp = await fetch('/creature-book-list', { method: 'GET' });
        if (resp.ok) {
            const data = await resp.json();
            if (Array.isArray(data)) return data;
        }
    } catch (err) {
        console.warn('/creature-book-list failed:', err);
    }

    // 3) Fallback to alternate API that returns simple list (if present)
    try {
        const resp2 = await fetch('/api/creatures/list', { method: 'GET' });
        if (resp2.ok) {
            const j = await resp2.json();
            if (j && Array.isArray(j.creatures)) {
                // normalize to the structure expected by the renderer
                return j.creatures.map(c => ({ folder: '', name: c.name || c.image || '', images: c.image ? [c.image] : [] }));
            }
        }
    } catch (err) {
        console.warn('/api/creatures/list fallback failed:', err);
    }

    // 4) last resort: return empty array (caller will show "No creatures")
    return [];
}

function parseNumberFromFolder(name) {
    const m = String(name).match(/^\s*0*([0-9]+)/);
    return m ? parseInt(m[1], 10) : Infinity;
}

function makeImageUrl(folder, filename) {
    if (!filename) return '';
    return folder
        ? `/Welcome Card Wars Kingdom_files/Creature Book/${folder}/${filename}`
        : `/Welcome Card Wars Kingdom_files/Creature Book/${filename}`;
}

function createWikiCard(item) {
	// item: { folder, name, images: [...] } or string (folder)
    const folder = (typeof item === 'string') ? item : (item.folder || '');
    const name = (typeof item === 'string') ? item : (item.name || folder);
    const imgs = (typeof item === 'string') ? [] : (item.images || item.files || []);
    const number = parseNumberFromFolder(folder || name);
    const first = imgs && imgs.length ? imgs[0] : null;
    const imgSrc = first ? makeImageUrl(folder, first) : '';

    const card = document.createElement('article');
    card.className = 'card-item border-2 rounded-xl p-4 bg-white/5 rarity-common flex flex-col items-center text-center';
    card.style.minHeight = '220px';
    // expose folder for admin actions
    card.dataset.folder = folder || '';

    const imgWrap = document.createElement('div');
    imgWrap.style.width = '100%';
    imgWrap.style.height = '160px';
    imgWrap.style.display = 'flex';
    imgWrap.style.alignItems = 'center';
    imgWrap.style.justifyContent = 'center';
    imgWrap.style.overflow = 'hidden';
    imgWrap.style.borderRadius = '12px';
    imgWrap.style.background = 'linear-gradient(180deg,#00000022,#00000011)';

    const img = document.createElement('img');
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    img.style.objectFit = 'contain';
    img.alt = name;
    img.loading = 'lazy';
    if (imgSrc) {
        img.src = imgSrc;
        img.onerror = () => { img.src = placeholderDataUrl(); };
    } else {
        img.src = placeholderDataUrl();
    }
    imgWrap.appendChild(img);

    const title = document.createElement('h3');
    title.className = 'text-lg font-bold mt-3';
    title.textContent = (Number.isFinite(number) ? `#${number} ` : '') + name;

    const meta = document.createElement('div');
    meta.className = 'text-xs text-white/60 mt-2';
    meta.textContent = (imgs && imgs.length) ? `${imgs.length} image(s)` : 'No images';

    card.appendChild(imgWrap);
    card.appendChild(title);
    card.appendChild(meta);

    // opcional: abrir modal con la primera imagen si existe
    if (imgSrc) {
        card.style.cursor = 'pointer';
        card.addEventListener('click', () => openImageModal(imgSrc, name));
    }

    return card;
}

// Add edit buttons to cards when admin is active
function enableAdminCardEdit() {
    try {
        // prefer DOM attribute (set by updateAdminUI) for reliable cross-scope detection
        const domFlag = document.documentElement.getAttribute('data-is-admin');
        const isAdmin = (domFlag === '1') || !!window.__IS_ADMIN__;
         document.querySelectorAll('#cardsGrid .card-item').forEach(card => {
             const existing = card.querySelector('.card-edit-btn');
             if (existing) existing.remove();
             if (!isAdmin) return;
             const btn = document.createElement('button');
             btn.type = 'button';
             btn.className = 'card-edit-btn';
             btn.textContent = 'Edit';
             // inline lightweight styles (avoid touching CSS files)
             btn.style.position = 'absolute';
             btn.style.top = '8px';
             btn.style.right = '8px';
             btn.style.padding = '6px 8px';
             btn.style.borderRadius = '8px';
             btn.style.background = 'rgba(98,95,255,0.95)';
             btn.style.color = '#fff';
             btn.style.border = 'none';
             btn.style.cursor = 'pointer';
             btn.style.zIndex = 40;
             const folder = card.dataset.folder || '';
             btn.title = folder || 'Edit item';
             btn.addEventListener('click', async (e) => {
                 e.stopPropagation();
                 // focus editor on this folder
                 window.__targetEditorFolder = folder;
                 const editorModal = document.getElementById('editorModal');
                 if (editorModal) editorModal.style.display = 'flex';
                 await loadEditableList();
             });
             card.style.position = card.style.position || 'relative';
             card.appendChild(btn);
         });
     } catch (err) {
         console.warn('enableAdminCardEdit error', err);
     }
}

function renderFolderList(items) {
    const container = document.getElementById('creatureFolders');
    const debug = document.getElementById('debugOutput');
    container.innerHTML = '';
    if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-white/60">No folders found.</div>';
        if (debug) debug.textContent = 'No items returned from /creature-book-list';
        return;
    }

    // Normalizar: items pueden ser strings o objetos {folder,name,...}
    const folders = items.map(it => {
        if (typeof it === 'string') return { folder: it, name: it };
        return { folder: it.folder || it.name || '', name: it.name || it.folder || it.folder };
    });

    // Ordenar por n√∫mero extra√≠do del nombre (si existe), luego por nombre
    folders.sort((a, b) => {
        const na = parseNumberFromFolder(a.folder);
        const nb = parseNumberFromFolder(b.folder);
        if (na !== nb) return na - nb;
        return (a.name || '').localeCompare(b.name || '');
    });

    // Crear bot√≥n / elemento por carpeta
    folders.forEach(f => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'filter-btn px-3 py-1 rounded-md bg-white/5 text-sm';
        btn.textContent = f.name;
        btn.title = f.folder;
        btn.addEventListener('click', () => {
            Array.from(container.children).forEach(c => c.classList.remove('filter-active'));
            btn.classList.add('filter-active');
            const dbg = document.getElementById('debugOutput');
            if (dbg) dbg.textContent = `Selected folder: ${f.folder}`;
        });
        container.appendChild(btn);
    });

    // Mostrar resumen en vez de todo el JSON
    if (debug) debug.textContent = `${folders.length} folders loaded.`;
}

function renderWiki(items) {
    const grid = document.getElementById('cardsGrid');
    const debug = document.getElementById('debugOutput');
    grid.innerHTML = '';
    if (!items || items.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-white/60">No creatures found.</div>';
        if (debug) debug.textContent = 'No items to render';
        return;
    }

    // Normalizar items a objetos {folder,name,images[]}
    const normalized = items.map(it => {
        if (typeof it === 'string') return { folder: it, name: it, images: [] };
        return { folder: it.folder || it.name || '', name: it.name || it.folder || '', images: it.images || it.files || [] };
    });

    // ordenar por n√∫mero
    normalized.sort((a,b) => {
        const na = parseNumberFromFolder(a.folder || a.name);
        const nb = parseNumberFromFolder(b.folder || b.name);
        if (na !== nb) return na - nb;
        return (a.name || '').localeCompare(b.name || '');
    });

    normalized.forEach(item => {
        const card = createWikiCard(item);
        grid.appendChild(card);
    });

    // Mostrar resumen en lugar del JSON completo
    if (debug) debug.textContent = `${normalized.length} creatures loaded.`;
    document.getElementById('cardCount').textContent = `Showing ${normalized.length} creatures`;
    // ensure admin edit buttons are present/removed according to current admin state
    enableAdminCardEdit();
}

/* verify endpoint and load */
async function verifyCreatureEndpoint() {
    const debug = document.getElementById('debugOutput');
    if (Array.isArray(window.__CREATURES__) && window.__CREATURES__.length) {
        if (debug) debug.textContent = 'Using injected window.__CREATURES__ data.';
        return true;
    }
    try {
        const res = await fetch('/creature-book-list', { method: 'GET' });
        if (res.ok) {
            if (debug) debug.textContent = `/creature-book-list reachable (status ${res.status}).`;
            return true;
        } else {
            if (debug) debug.textContent = `/creature-book-list returned status ${res.status}.`;
            return false;
        }
    } catch (err) {
        if (debug) debug.textContent = `Error contacting /creature-book-list: ${err.message}\n\nAseg√∫rate de que el backend est√© ejecut√°ndose. Ejemplo: python app.py y prueba: curl http://127.0.0.1:5000/creature-book-list`;
        console.error(err);
        return false;
    }
}

async function loadAndRenderWiki() {
     const debug = document.getElementById('debugOutput');
    reportDebug('Verifying /creature-book-list ...');
    try {
        const ok = await verifyCreatureEndpoint();
        if (!ok) {
            const container = document.getElementById('cardsGrid');
            container.innerHTML = '<div class="text-white/60">Endpoint /creature-book-list no disponible. Revisa backend.</div>';
            reportDebug('Endpoint not reachable, aborted render.');
            return;
        }
        reportDebug('Fetching creature list ...');
        const list = await fetchCreatureBookList();
        reportDebug('Creature list received (' + (Array.isArray(list) ? list.length : typeof list) + ')');
        // normalize if server returned object { creatures: [...] }
        let normalizedList = list;
        if (list && !Array.isArray(list) && Array.isArray(list.creatures)) normalizedList = list.creatures;
        if (!Array.isArray(normalizedList)) normalizedList = [];
        renderWiki(normalizedList);
         } catch (err) {
             const container = document.getElementById('cardsGrid');
             container.innerHTML = '<div class="text-white/60">Error loading creatures.</div>';
        reportDebug('Error loading creatures: ' + (err && err.message ? err.message : String(err)));
        console.error(err);
     }
 }
 
// Define loadEditableList function
async function loadEditableList() {
    try {
        const resp = await fetch('/creature-book-list');
        if (!resp.ok) throw new Error('Failed to load list');
        const creatures = await resp.json();
        renderEditableList(creatures);
    } catch (err) {
        console.error('loadEditableList error:', err);
        alert('Error loading creature list: ' + err.message);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        // limpiar listado de botones/antiguo
        const folders = document.getElementById('creatureFolders');
        if (folders) folders.innerHTML = '';
        // cargar y mostrar wiki cards
        loadAndRenderWiki().catch(e => reportDebug('initial loadAndRenderWiki failed: ' + (e && e.message ? e.message : e)));
        // enable edit buttons for server-rendered cards immediately if admin
        try { enableAdminCardEdit(); } catch(e) { /* ignore */ }
        // observe data-is-admin changes so edit buttons update automatically on login/logout
        try {
            const mo = new MutationObserver((mutations) => {
                for (const m of mutations) {
                    if (m.type === 'attributes' && m.attributeName === 'data-is-admin') {
                        try { enableAdminCardEdit(); } catch(e){/*ignore*/ }
                    }
                }
            });
            mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-is-admin'] });
        } catch(e) { console.warn('MutationObserver unavailable', e); }

        // wire header/mobile edit controls
        const headerEditBtn = document.getElementById('headerEditBtn');
        const mobileEditLink = document.getElementById('mobileEditLink');
        const pageEditBtn = document.getElementById('pageEditBtn');
        const editModeBtn = document.getElementById('editModeBtn');
        const editorModal = document.getElementById('editorModal');
        // Explicaci√≥n:
        // Esta funci√≥n abre el modal de edici√≥n y carga la lista editable de criaturas.
        // Si la funci√≥n loadEditableList no existe, muestra un mensaje de depuraci√≥n.
        async function openEditorModal(e) {
            e && e.preventDefault && e.preventDefault();
            const isAdmin = !!window.__IS_ADMIN__ || document.documentElement.getAttribute('data-is-admin') === '1';
            if (!isAdmin) {
                alert('Debes iniciar sesi√≥n como administrador para editar. Haz clic en "Admin Login" para continuar.');
                return;
            }
            if (editorModal) editorModal.style.display = 'flex';
            if (typeof window.loadEditableList === 'function') {
                await window.loadEditableList();
                // Actualiza el texto de ayuda para dejar claro el prop√≥sito
                const help = document.getElementById('editorHelp');
                if (help) help.textContent = 'Puedes renombrar las cartas y a√±adir im√°genes a las criaturas. Haz clic en "Rename" para cambiar el nombre de la carta y en "Upload" para a√±adir una imagen.';
            } else {
                reportDebug('No se encontr√≥ la funci√≥n loadEditableList. Verifica que est√© definida en tu JS principal.');
                const dbg = document.getElementById('debugOutput');
                if (dbg) dbg.textContent = 'No se encontr√≥ la funci√≥n loadEditableList. Revisa tu c√≥digo JS principal.';
            }
        }

        // Make it global
        window.openEditorModal = openEditorModal;
        // Asigna el evento click a los botones de edici√≥n
        if (headerEditBtn) headerEditBtn.addEventListener('click', openEditorModal);
        if (mobileEditLink) mobileEditLink.addEventListener('click', openEditorModal);
        if (pageEditBtn) pageEditBtn.addEventListener('click', openEditorModal);
        if (editModeBtn) editModeBtn.addEventListener('click', openEditorModal);
    } catch (e) {
        reportDebug('DOMContentLoaded handler error: ' + (e && e.message ? e.message : e));
    }
});

function renderEditableList(creatures) {
    const container = document.getElementById('editorList');
    container.innerHTML = '';
    if (!creatures || creatures.length === 0) {
        container.innerHTML = '<div style="color:#aaa;text-align:center;padding:20px;">No creatures found.</div>';
        return;
    }
    creatures.forEach(c => {
        const item = document.createElement('div');
        item.style.border = '1px solid #333';
        item.style.borderRadius = '8px';
        item.style.padding = '12px';
        item.style.marginBottom = '10px';
        item.style.background = '#111';

        const title = document.createElement('h4');
        title.textContent = c.name || c.folder;
        title.style.margin = '0 0 8px 0';
        title.style.color = '#fff';
        item.appendChild(title);

        // Rename input
        const renameDiv = document.createElement('div');
        renameDiv.style.display = 'flex';
        renameDiv.style.gap = '8px';
        renameDiv.style.marginBottom = '8px';

        const renameInput = document.createElement('input');
        renameInput.type = 'text';
        renameInput.value = c.name || '';
        renameInput.placeholder = 'New name';
        renameInput.style.flex = '1';
        renameInput.style.padding = '6px';
        renameInput.style.borderRadius = '4px';
        renameInput.style.border = '1px solid #555';
        renameInput.style.background = '#222';
        renameInput.style.color = '#fff';

        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.style.padding = '6px 12px';
        renameBtn.style.borderRadius = '4px';
        renameBtn.style.border = 'none';
        renameBtn.style.background = '#625fff';
        renameBtn.style.color = '#fff';
        renameBtn.style.cursor = 'pointer';
        renameBtn.addEventListener('click', async () => {
            const newName = renameInput.value.trim();
            if (!newName) return alert('Name cannot be empty');
            try {
                const resp = await fetch('/creature-book-rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder: c.folder, newName })
                });
                const data = await resp.json();
                if (data.ok) {
                    alert('Renamed successfully');
                    await loadEditableList(); // refresh
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Rename failed: ' + err.message);
            }
        });

        renameDiv.appendChild(renameInput);
        renameDiv.appendChild(renameBtn);
        item.appendChild(renameDiv);

        // Upload input
        const uploadDiv = document.createElement('div');
        uploadDiv.style.display = 'flex';
        uploadDiv.style.gap = '8px';

        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.accept = 'image/*';
        uploadInput.style.flex = '1';

        const uploadBtn = document.createElement('button');
        uploadBtn.textContent = 'Upload Image';
        uploadBtn.style.padding = '6px 12px';
        uploadBtn.style.borderRadius = '4px';
        uploadBtn.style.border = 'none';
        uploadBtn.style.background = '#00ff88';
        uploadBtn.style.color = '#000';
        uploadBtn.style.cursor = 'pointer';
        uploadBtn.addEventListener('click', async () => {
            const file = uploadInput.files[0];
            if (!file) return alert('Select a file first');
            const formData = new FormData();
            formData.append('folder', c.folder);
            formData.append('file', file);
            try {
                const resp = await fetch('/creature-book-upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.ok) {
                    alert('Uploaded successfully');
                    await loadEditableList(); // refresh
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Upload failed: ' + err.message);
            }
        });

        uploadDiv.appendChild(uploadInput);
        uploadDiv.appendChild(uploadBtn);
        item.appendChild(uploadDiv);

        container.appendChild(item);
    });
}

function updateAdminUI() {
    const isAdmin = !!window.__IS_ADMIN__ || document.documentElement.getAttribute('data-is-admin') === '1';
    document.documentElement.setAttribute('data-is-admin', isAdmin ? '1' : '0');

    // Show/hide edit buttons
    const buttons = [
        document.getElementById('headerEditBtn'),
        document.getElementById('pageEditBtn'),
        document.getElementById('editModeBtn'),
        document.getElementById('mobileEditLink')
    ];
    buttons.forEach(btn => {
        if (btn) btn.style.display = isAdmin ? 'inline-flex' : 'none';
    });

    // Update admin toggle button
    const adminToggle = document.getElementById('adminToggleBtn');
    if (adminToggle) {
        adminToggle.textContent = isAdmin ? 'Logout' : 'Login';
        adminToggle.onclick = isAdmin ? logoutAdmin : showLoginModal;
    }
}

async function logoutAdmin() {
    try {
        await fetch('/logout', { method: 'POST' });
        window.__IS_ADMIN__ = false;
        updateAdminUI();
        location.reload(); // refresh to hide admin features
    } catch (err) {
        console.error('Logout error:', err);
    }
}

function showLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) modal.style.display = 'flex';
}

// Wire login modal events
document.addEventListener('DOMContentLoaded', () => {
    const loginModal = document.getElementById('loginModal');
    const loginSubmit = document.getElementById('loginSubmit');
    const loginCancel = document.getElementById('loginCancel');
    const loginPassword = document.getElementById('loginPassword');
    const loginStatus = document.getElementById('loginStatus');

    if (loginSubmit) {
        loginSubmit.addEventListener('click', async () => {
            const pwd = loginPassword.value;
            try {
                const resp = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });
                const data = await resp.json();
                if (data.ok) {
                    window.__IS_ADMIN__ = true;
                    updateAdminUI();
                    if (loginModal) loginModal.style.display = 'none';
                    location.reload(); // refresh to show admin features
                } else {
                    if (loginStatus) loginStatus.textContent = data.error || 'Login failed';
                }
            } catch (err) {
                if (loginStatus) loginStatus.textContent = 'Error: ' + err.message;
            }
        });
    }

    if (loginCancel) {
        loginCancel.addEventListener('click', () => {
            if (loginModal) loginModal.style.display = 'none';
        });
    }

    // Wire editor modal close
    const editorClose = document.getElementById('editorClose');
    const editorCloseBottom = document.getElementById('editorCloseBottom');
    const editorRefresh = document.getElementById('editorRefresh');
    const editorModal = document.getElementById('editorModal');

    if (editorClose) {
        editorClose.addEventListener('click', () => {
            if (editorModal) editorModal.style.display = 'none';
        });
    }
    if (editorCloseBottom) {
        editorCloseBottom.addEventListener('click', () => {
            if (editorModal) editorModal.style.display = 'none';
        });
    }
    if (editorRefresh) {
        editorRefresh.addEventListener('click', loadEditableList);
    }

    // Initial UI update
    updateAdminUI();
});
