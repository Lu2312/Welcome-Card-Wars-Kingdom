{% extends "base.html" %}
{% block additional_preloads %}
<link rel="preload" as="image" href="/resources/home.gif">
{% endblock %}
{% block content %}
<!-- ESTILOS DEL HERO:
     - Para cambiar el fondo, a√±ade: style="background: linear-gradient(...);" a la div
     - Para ajustar el espaciado, modifica padding o margin en l√≠nea
     - Los estilos de .page-hero y .page-title est√°n en /static/css/styles.css
-->
<div class="page-hero container">
    <h1 class="page-title">Spells / Action Cards</h1>
    <p class="muted">Complete action and spell card library. Uses external JSON and local resources for artwork.</p>
</div>

{# Barra de filtros eliminada para mostrar todas las cartas en orden del JSON #}

<section class="container" id="spells-grouped">
    {% if spells|length == 0 %}
        <div class="card" style="padding:20px;">No spells found. If the remote JSON couldn't be fetched, try running the app with network access or create `data/db_ActionCards.json` locally as cache.</div>
    {% endif %}
    {# Build a map of original indexes so we can preserve JSON ordering client-side #}
    {% set _ns = namespace(map={}) %}
    {% for s in spells %}
        {% set _ = _ns.map.update({ (s.get('ID') or s.get('Name') or ''): loop.index0 }) %}
    {% endfor %}

    {% for cat in category_list %}
        <!-- ESTILOS DE LOS T√çTULOS DE CATEGOR√çA:
             - margin-top:1.5rem: espacio superior del t√≠tulo
             - Para cambiar el tama√±o de fuente: a√±adir font-size:24px
             - Para cambiar el color: a√±adir color:#colorHex
        -->
        <h3 style="margin-top:1.5rem;">{{ cat }} <small class="muted">({{ category_counts.get(cat,0) }})</small></h3>
        <!-- ESTILOS DE LA CUADR√çCULA DE HECHIZOS:
             - .spells-grid est√° definida en /static/css/styles.css
             - Probablemente usa display:grid con grid-template-columns
             - Para cambiar el n√∫mero de columnas, modifica grid-template-columns en CSS
             - Para ajustar el espacio entre tarjetas, modifica gap en CSS
        -->
        <div class="spells-grid">
            {% for spell in spells|selectattr('category','equalto',cat)|list %}
            {% set id = (spell.get('ID') or spell.get('Name') or '').strip() %}
            {# extract numeric suffix from IDs like CORN_0001 -> 1 #}
            {% set card_num = (id.split('_')[-1]|int) if '_' in id and id.split('_')[-1].isdigit() else '' %}
            {% set name = spell.get('display_name') or spell.get('Name') or spell.get('ID') %}
            {% set desc = spell.get('display_description') or spell.get('Description') or spell.get('CardText') or '' %}
            {% set frame = spell.get('CardFrame') or spell.get('CardFramePath') or '' %}
            {% set sprite = spell.get('SpriteName') or spell.get('UITexture') or spell.get('Icon') or '' %}
            {% set cost = spell.get('Cost') or spell.get('Energy') or '' %}
            {# Pasar ID y Name del spell para mejorar la b√∫squeda de iconos #}
            {% set frame_path = spell_asset('cardframes', frame, id, name) or '/resources/dungeon/Screenshot-placeholder.svg' %}
            {% set sprite_path = spell_asset('cardicons', sprite, id, name) or '/resources/dungeon/Spell-Icon-placeholder.svg' %}
            <!-- ESTILOS DE CADA TARJETA:
                 - .card y .spell-card: estilos base definidos en /static/css/styles.css
                 - Para a√±adir sombra: style="box-shadow: 0 4px 8px rgba(0,0,0,0.3);"
                 - Para cambiar el fondo: a√±adir background:#color o background:linear-gradient(...)
                 - Para a√±adir borde: a√±adir border:2px solid #color
                 - Para efectos hover, mejor definir en CSS: .spell-card:hover { transform: scale(1.05); }
            -->
            <article class="card spell-card" data-id="{{ id }}" data-name="{{ name|lower }}" data-faction="{{ spell.get('Faction','')|lower }}" data-type="{{ (spell.get('TypeText') or '')|lower }}" data-cost="{{ (spell.get('Cost') or spell.get('Energy') or '') }}" data-number="{{ card_num }}" data-category="{{ (spell.get('category') or 'Other')|lower }}" data-index="{{ _ns.map.get(id, loop.index0) }}">
                <!-- CONTENEDOR DEL FRAME DE LA CARTA:
                     - .spell-frame-wrap contiene la imagen de fondo y los elementos superpuestos
                     - position:relative permite posicionar elementos absolutos dentro
                -->
                <div class="spell-frame-wrap">
                    <!-- IMAGEN DEL FRAME (fondo de la carta):
                         - .spell-frame: position:absolute con width:100% (z-index: 1, encima del icono)
                         - Para ajustar opacidad: a√±adir style="opacity:0.8;"
                         - Para aplicar filtros: style="filter: brightness(1.2) contrast(1.1);"
                         
                         ORDEN DE CAPAS (z-index):
                         - spell-icon: z-index: 0 (capa inferior - icono debajo)
                         - spell-frame: z-index: 1 (capa media - frame encima del icono)
                         - spell-cost, spell-number, spell-info: z-index: 10 (capa superior - siempre visibles)
                         
                         Este orden asegura que:
                         1. El icono quede debajo del frame decorativo
                         2. El frame cubra los bordes del icono
                         3. Los textos e informaci√≥n sean siempre visibles encima de todo
                    -->
                    <img class="spell-frame" src="{{ frame_path }}" alt="{{ frame }}" loading="lazy" decoding="async">
                    {% set missing_icon = ('placeholder' in (sprite_path or '').lower()) %}
                    <!-- IMAGEN DEL ICONO (sprite central):
                         - .spell-icon: superpuesta sobre el frame (z-index: 0, debajo del frame)
                         - El outline:2px solid #a00 indica iconos faltantes (placeholder)
                         - Para cambiar el tama√±o: a√±adir width y height en style
                         - Para cambiar posici√≥n: modificar top/left/right/bottom en CSS
                         
                         B√öSQUEDA MEJORADA DE ICONOS:
                         La funci√≥n spell_asset ahora busca iconos usando:
                         1. El valor de SpriteName/UITexture del JSON
                         2. El ID del spell (ej: CORN_0001, PLAINS_0023)
                         3. El Name del spell
                         4. Variaciones sin guiones/espacios
                         
                         Esto mejora significativamente la detecci√≥n autom√°tica de iconos.
                    -->
                    <img class="spell-icon" src="{{ sprite_path }}" alt="{{ name }}" loading="lazy" decoding="async" {% if missing_icon %} style="outline:2px solid #a00;" title="No icon found (placeholder)" {% endif %}>
                    {% if is_admin %}
                    <div class="spell-admin-controls" style="position:absolute; right:6px; top:6px; z-index:20; display:flex; gap:6px;">
                        <button class="btn small btn-edit-icon" data-key="{{ sprite }}" title="Edit icon">üñºÔ∏è</button>
                        <small style="color:#ddd; font-size:11px;">{{ icon_map.get(sprite, '') }}</small>
                    </div>
                    {% endif %}
                    <!-- INDICADOR DE COSTO:
                         - .spell-cost: muestra el costo de man√°/energ√≠a
                         - Probablemente position:absolute con estilos en CSS
                         - Para cambiar color de fondo: a√±adir style="background:#color;"
                         - Para cambiar tama√±o de fuente: style="font-size:20px;"
                         - Para cambiar posici√≥n: modificar top/right/etc en CSS
                    -->
                    <div class="spell-cost">{{ cost }}</div>
                    {% if card_num %}
                    <!-- N√öMERO DE CARTA:
                         - .spell-number: muestra el n√∫mero de colecci√≥n
                         - Para cambiar color del texto: style="color:#gold;"
                         - Para a√±adir fondo: style="background:rgba(0,0,0,0.7); padding:4px;"
                    -->
                    <div class="spell-number">#{{ card_num }}</div>
                    {% endif %}
                    <!-- SUPERPOSICI√ìN DE INFORMACI√ìN (caption):
                         - La altura se controla con --spell-caption-height en CSS
                         - Para cambiar el fondo del overlay: modificar .spell-info en CSS
                    -->
                    <!-- INFORMACI√ìN DE LA CARTA:
                         - .spell-info: contiene nombre y descripci√≥n
                         - Para cambiar el fondo: a√±adir style="background:rgba(0,0,0,0.8);"
                         - Para ajustar el padding: style="padding:12px;"
                         - Para cambiar la alineaci√≥n del texto: style="text-align:center;"
                    -->
                    <div class="spell-info">
                    <!-- NOMBRE DE LA CARTA:
                         - Para cambiar color: style="color:#colorHex;"
                         - Para cambiar tama√±o: style="font-size:18px;"
                         - Para a√±adir sombra al texto: style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"
                    -->
                    <h3>{{ name }}</h3>
                    <!-- VISTA PREVIA DE LA DESCRIPCI√ìN (primera l√≠nea) -->
                    <p class="desc-preview">{{ desc.splitlines()[0] if desc else '' }}</p>
                    {% if desc and desc != (desc.splitlines()[0] if desc else '') %}
                    <!-- DESCRIPCI√ìN COMPLETA (oculta por defecto):
                         - style="display:none;" la oculta inicialmente
                         - JavaScript la muestra al hacer clic en "Show more"
                    -->
                    <p class="desc-full" style="display:none;">{{ desc }}</p>
                    <!-- ENLACE TOGGLE:
                         - Para cambiar color: a√±adir .desc-toggle en CSS con color:#colorHex
                         - Para eliminar el subrayado: style="text-decoration:none;"
                    -->
                    <p><a href="#" class="desc-toggle">Show more</a></p>
                    {% endif %}
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
    {% endfor %}
</section>

{# Duplicate grouped section removed to avoid rendering spells twice (performance improvement) #}

<script>
document.addEventListener('DOMContentLoaded', function(){
    /* ========================================
       SISTEMA SIMPLIFICADO - SIN FILTROS
       ========================================
       Las cartas se muestran en el orden original del archivo JSON.
       No hay filtros ni ordenamiento din√°mico.
       El orden sigue la secuencia oficial del juego:
       CORN ‚Üí PLAINS ‚Üí SAND ‚Üí NICE ‚Üí SWAMP ‚Üí OBSIDIAN ‚Üí TEST ‚Üí Leader
    */
    // description toggle handlers
    document.addEventListener('click', function(e){
        const t = e.target;
        if(t && t.classList && t.classList.contains('desc-toggle')){
            e.preventDefault();
            const parent = t.closest('.spell-info');
            if(!parent) return;
            const full = parent.querySelector('.desc-full');
            if(!full) return;
            if(full.style.display === 'none' || full.style.display === ''){
                full.style.display = 'block';
                t.textContent = 'Show less';
            } else {
                full.style.display = 'none';
                t.textContent = 'Show more';
            }
        }
    });

    // Admin icon editor
    async function openIconEditor(key, imgElt, currentInputElt){
        try{
            const res = await fetch('/admin/icon-mappings/suggestions/' + encodeURIComponent(key));
            if(!res.ok){ alert('No suggestions (not authorized or error).'); return; }
            const data = await res.json();
            // build modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed'; modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0; modal.style.background = 'rgba(0,0,0,0.6)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex = 9999;
            const box = document.createElement('div'); box.style.background='#0b0b0d'; box.style.padding='14px'; box.style.border='1px solid #222'; box.style.borderRadius='8px'; box.style.maxWidth='900px'; box.style.width='90%'; box.style.maxHeight='80%'; box.style.overflow='auto';
            const title = document.createElement('h3'); title.style.margin='0 0 6px 0'; title.textContent = 'Edit icon for ' + key; box.appendChild(title);
            const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit, minmax(140px,1fr))'; grid.style.gap='8px';
            // browse all files control
            const browseBar = document.createElement('div'); browseBar.style.display='flex'; browseBar.style.gap='8px'; browseBar.style.marginBottom='8px';
            const browseBtn = document.createElement('button'); browseBtn.textContent = 'Browse all files'; browseBtn.className='btn small';
            const searchInput = document.createElement('input'); searchInput.placeholder = 'Filter files...'; searchInput.style.flex='1'; searchInput.style.padding='6px'; searchInput.style.borderRadius='6px'; searchInput.style.border='1px solid #333';
            browseBar.appendChild(browseBtn); browseBar.appendChild(searchInput); box.appendChild(browseBar);
            // helper to create preview src
            function previewFor(file){
                if(!file) return '';
                if(file.startsWith('/')) return file;
                if(file.toLowerCase().startsWith('resources/')) return '/' + file.replace(/\\\\/g,'/');
                return '/resources/spells/cardicons/' + file;
            }
            data.candidates.forEach(c => {
                const card = document.createElement('div'); card.style.background='#0f1113'; card.style.padding='6px'; card.style.border='1px solid #222'; card.style.borderRadius='6px'; card.style.textAlign='center';
                const img = document.createElement('img'); img.src = previewFor(c.file); img.style.maxWidth='100%'; img.style.height='80px'; img.style.objectFit='contain'; img.alt = c.file;
                const lbl = document.createElement('div'); lbl.style.marginTop='6px'; lbl.style.fontSize='12px'; lbl.style.color='#ddd'; lbl.textContent = c.file + (c.score ? ' ('+c.score+')' : '');
                const btn = document.createElement('button'); btn.textContent = 'Use'; btn.className='btn small'; btn.style.marginTop='6px'; btn.addEventListener('click', async ()=>{
                    const mappingValue = (c.file.startsWith('resources/') ? '/' + c.file : c.file);
                    const payload = {}; payload[key] = mappingValue;
                    const r = await fetch('/admin/icon-mappings/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    const j = await r.json();
                    if(j && j.ok){
                        // update currentInputElt and image
                        if(currentInputElt) currentInputElt.value = mappingValue;
                        const newSrc = previewFor(c.file);
                        if(imgElt){ imgElt.src = newSrc; }
                        document.body.removeChild(modal);
                    } else {
                        alert('Failed to save: ' + (j && j.error || 'unknown'));
                    }
                });
                card.appendChild(img); card.appendChild(lbl); card.appendChild(btn); grid.appendChild(card);
            });
            // container for browse results (initially hidden)
            const browseContainer = document.createElement('div'); browseContainer.style.display='none'; browseContainer.style.marginTop='8px'; browseContainer.style.gridGap='8px';
            const browseGrid = document.createElement('div'); browseGrid.style.display='grid'; browseGrid.style.gridTemplateColumns='repeat(auto-fit, minmax(140px,1fr))'; browseGrid.style.gap='8px';
            browseContainer.appendChild(browseGrid);
            box.appendChild(browseContainer);

            async function loadBrowse(filter){
                browseGrid.innerHTML = '';
                const url = '/admin/icon-mappings/files' + (filter ? ('?q=' + encodeURIComponent(filter)) : '');
                const r = await fetch(url);
                if(!r.ok) { browseGrid.textContent = 'Failed to load files.'; return; }
                const j = await r.json();
                const list = j.files || [];
                list.forEach(fn => {
                    const card = document.createElement('div'); card.style.background='#0f1113'; card.style.padding='6px'; card.style.border='1px solid #222'; card.style.borderRadius='6px'; card.style.textAlign='center';
                    const img = document.createElement('img'); img.src = '/resources/spells/cardicons/' + fn; img.style.maxWidth='100%'; img.style.height='80px'; img.style.objectFit='contain'; img.alt = fn;
                    const lbl = document.createElement('div'); lbl.style.marginTop='6px'; lbl.style.fontSize='12px'; lbl.style.color='#ddd'; lbl.textContent = fn;
                    const btn = document.createElement('button'); btn.textContent = 'Use'; btn.className='btn small'; btn.style.marginTop='6px'; btn.addEventListener('click', async ()=>{
                        const mappingValue = fn;
                        const payload = {}; payload[key] = mappingValue;
                        const res = await fetch('/admin/icon-mappings/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        const jr = await res.json();
                        if(jr && jr.ok){ if(currentInputElt) currentInputElt.value = mappingValue; if(imgElt) imgElt.src = '/resources/spells/cardicons/' + fn; document.body.removeChild(modal); } else { alert('Failed to save: ' + (jr && jr.error || 'unknown')); }
                    });
                    card.appendChild(img); card.appendChild(lbl); card.appendChild(btn); browseGrid.appendChild(card);
                });
            }

            browseBtn.addEventListener('click', async ()=>{ loadBrowse(searchInput.value.trim()); browseContainer.style.display = ''; });
            searchInput.addEventListener('keydown', async (ev)=>{ if(ev.key === 'Enter'){ loadBrowse(searchInput.value.trim()); browseContainer.style.display = ''; } });
            box.appendChild(grid);
            const close = document.createElement('div'); close.style.marginTop='8px'; close.style.textAlign='right';
            const closeBtn = document.createElement('button'); closeBtn.textContent = 'Close'; closeBtn.className='btn admin-btn-cancel'; closeBtn.addEventListener('click', ()=>document.body.removeChild(modal));
            close.appendChild(closeBtn); box.appendChild(close);
            modal.appendChild(box); document.body.appendChild(modal);
        }catch(err){ console.error(err); alert('Error fetching suggestions.'); }
    }

    if(document.querySelectorAll('.btn-edit-icon').length){
        document.querySelectorAll('.btn-edit-icon').forEach(btn => {
            btn.addEventListener('click', function(e){
                const key = this.getAttribute('data-key');
                // find image element near this button
                const article = this.closest('.spell-card');
                const imgElt = article && article.querySelector('.spell-icon');
                const currentInput = this.closest('.spell-frame-wrap').querySelector('.mapping-current');
                openIconEditor(key, imgElt, currentInput);
            });
        });
    }
});
</script>

{% endblock %}