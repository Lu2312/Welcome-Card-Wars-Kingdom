{% extends "base.html" %}
{% block additional_preloads %}
<link rel="preload" as="image" href="/resources/home.gif">
{% endblock %}
{% block content %}
<div class="download-page">
    <div class="container">
        <div class="download-header">
            <h1>Download Card Wars Kingdom</h1>
            <p>Get the latest version and start playing now!</p>
        </div>
        
        <div id="release-content">
            <div class="loading">
                <p>Loading latest release information...</p>
            </div>
        </div>
        
        <div class="direct-link">
            <p>View all releases on <a href="https://github.com/Sgsysysgsgsg/Card-Wars-Kingdom-Revived/releases" target="_blank">GitHub</a></p>
        </div>
    </div>
    <script>
        async function loadLatestRelease() {
            const contentDiv = document.getElementById('release-content');
            
            try {
                const response = await fetch('/api/latest-release');
                const data = await response.json();
                
                if (data.error) {
                    contentDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ö†Ô∏è Could not load release information</h3>
                            <p>${data.error}</p>
                            <p>Please visit <a href="https://github.com/Sgsysysgsgsg/Card-Wars-Kingdom-Revived/releases/tag/v4.0.4" target="_blank">GitHub releases page</a> to download manually.</p>
                        </div>
                    `;
                    return;
                }
                
                // Format date
                const releaseDate = new Date(data.published_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Format file size
                function formatBytes(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
                
                // Build download buttons
                let downloadButtons = '';
                if (data.assets && data.assets.length > 0) {
                    data.assets.forEach(asset => {
                        downloadButtons += `
                            <a href="${asset.download_url}" class="download-btn" download>
                                <div class="download-info">
                                    <span class="file-name">${asset.name}</span>
                                    <span class="file-size">${formatBytes(asset.size)} ‚Ä¢ ${asset.download_count} downloads</span>
                                </div>
                                <span>‚¨áÔ∏è</span>
                            </a>
                        `;
                    });
                } else {
                    downloadButtons = `
                        <a href="${data.html_url}" class="download-btn" target="_blank">
                            <div class="download-info">
                                <span class="file-name">View on GitHub</span>
                                <span class="file-size">No direct downloads available</span>
                            </div>
                            <span>üîó</span>
                        </a>
                    `;
                }
                
                // Format release notes
                const releaseNotes = data.body ? data.body.replace(/\n/g, '<br>') : 'No release notes available.';
                
                contentDiv.innerHTML = `
                    <div class="version-card">
                        <div class="version-info">
                            <div>
                                <div class="version-tag">${data.version}</div>
                                <div>${data.name}</div>
                            </div>
                            <div class="release-date">Released on ${releaseDate}</div>
                        </div>
                        
                        <div class="release-notes">
                            <h3>üìù Release Notes</h3>
                            <div>${releaseNotes}</div>
                        </div>
                        
                        <div class="download-buttons">
                            ${downloadButtons}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Error loading release</h3>
                        <p>${error.message}</p>
                        <p>Please visit <a href="https://github.com/Sgsysysgsgsg/Card-Wars-Kingdom-Revived/releases/tag/v4.0.4" target="_blank">GitHub releases page</a> to download manually.</p>
                    </div>
                `;
            }
        }
        
        // Load release on page load
        loadLatestRelease();
    </script>
    </div>
{% endblock %}
